/*! sagyChart 2014-03-08 by LiTao */
!function(a,b){var c=this;"function"==typeof define&&define.amd&&define(b),c[a]=b()}.call(this,"sagyChart",function(){function a(a){return"string"==typeof a}function b(a){return"[object Array]"===t.call(a)}function c(a){return"[object Function]"===t.call(a)}function d(a){return"number"==typeof a}function e(a){var b;for(b in a)return!1;return!0}function f(){return"sagy"+A().toString(36).substring(2,6)}function g(a){throw new Error(a)}function h(a){console.log(a)}function i(a,c){var d,e,f=0;if(a){if(b(a))for(e=a.length;e>f&&(d=c.call(a[f],f,a[f]),d!==!1);f++);else for(f in a)if(d=c.call(a[f],f,a[f]),d===!1)break;return a}}function j(){var a,b=arguments.length,c={},d=function(a,b){var c,e;"object"!=typeof a&&(a={});for(e in b)b.hasOwnProperty(e)&&(c=b[e],a[e]=c&&"object"==typeof c&&"[object Array]"!==t.call(c)&&"number"!=typeof c.nodeType?d(a[e]||{},c):b[e]);return a};for(a=0;b>a;a++)c=d(c,arguments[a]);return c}function k(a){return a.setHours(0),a.setMinutes(0),a.setSeconds(0),a.setMilliseconds(0),a.getTime()}function l(a,b){var c,d,e=parseFloat(a),f=!1;return isNaN(e)?b?null:"--":(0>e&&(f=!0,e*=-1),c=e>=1e4?1:e>=1e3?10:e>=100?100:e>=10?1e3:1e4,e=z(e*c)/c,b?e:(d=e>=1e5?e.toExponential(1):e.toString(),f&&(d="-"+d),d))}function m(a,b){a&&(this.x=a),this.y=b}function n(a,b){var c,d=f();return c=F.createElement("div"),c.setAttribute("id",d),b.appendChild(c),a.chart.renderTo=d,new Highcharts.Chart(a)}function o(a,b){var c=b||1;switch(!0){case 10*u*c>=a:return 1;case a>10*u*c&&v*c>=a:return 2;case a>v*c&&w*c>=a:return 3;case a>w*c&&x*c>=a:return 4;case a>x*c:return 5;default:return 2}}function p(a,b){return function(){b[a].apply(b,arguments)}}function q(){this.init.apply(this,arguments)}var r="0.10.3",s={},t=s.toString,u=6e4,v=60*u,w=24*v,x=7*w,y=Math,z=y.round,A=y.random,B=y.max,C=y.min,D=y.pow,E="object"==typeof window&&window||this,F=E.document,G=E.unitDocs={Wh:{lowerLevel:null,higherLevel:"kWh",ratio:1e3},kWh:{lowerLevel:"Wh",higherLevel:"MWh",ratio:1e3},MWh:{lowerLevel:"kWh",higherLevel:"GWh",ratio:1e3},GWh:{lowerLevel:"MWh",higherLevel:"TWh",ratio:1e3},TWh:{lowerLevel:"GWh",higherLevel:"PWh",ratio:1e3},PWh:{lowerLevel:"TWh",higherLevel:"EWh",ratio:1e3},EWh:{lowerLevel:"PWh",higherLevel:"ZWh",ratio:1e3},ZWh:{lowerLevel:"EWh",higherLevel:"YWh",ratio:1e3},YWh:{lowerLevel:"ZWh",higherLevel:null,ratio:1e3},W:{lowerLevel:null,higherLevel:"kW",ratio:1e3},kW:{lowerLevel:"W",higherLevel:"MW",ratio:1e3},MW:{lowerLevel:"kW",higherLevel:"GW",ratio:1e3},GW:{lowerLevel:"MW",higherLevel:"TW",ratio:1e3},TW:{lowerLevel:"GW",higherLevel:"PW",ratio:1e3},PW:{lowerLevel:"TW",higherLevel:"EW",ratio:1e3},EW:{lowerLevel:"PW",higherLevel:"ZW",ratio:1e3},ZW:{lowerLevel:"EW",higherLevel:"YW",ratio:1e3},YW:{lowerLevel:"ZW",higherLevel:null,ratio:1e3},"元":{lowerLevel:null,higherLevel:"万元",ratio:1e3},"万元":{lowerLevel:"元",higherLevel:"亿元",ratio:1e3},"亿元":{lowerLevel:"万元",higherLevel:null,ratio:1e3},g:{lowerLevel:null,higherLevel:"kg",ratio:1e3},kg:{lowerLevel:"g",higherLevel:null,ratio:1e3},T:{lowerLevel:"kg",higherLevel:null,ratio:1e3},J:{lowerLevel:null,higherLevel:"kJ",ratio:1e3},kJ:{lowerLevel:"J",higherLevel:"MJ",ratio:1e3},MJ:{lowerLevel:"kJ",higherLevel:null,ratio:1e3},L:{lowerLevel:null,higherLevel:"T",ratio:1e3},"m³":{lowerLevel:"L",higherLevel:null,ratio:1e3}},H=function(){var b=arguments,c=b[0],d=b[1];return a(c)&&(c={renderTo:b[0]}),new H.fn.init(c,d)},I=function(){var a=this.series.chart;a.hoverPoint&&J.call(this),a.svg_yRect=a.renderer.image(a.resourcePath+"panel_Y.png",a.plotLeft-80,this.plotY+a.plotTop-21,80,50).attr({fill:"white",zIndex:99}).add();var b,c=l(this.y),d=c.length>4?20:28,e=d+"px";switch(a.svg_yText=a.renderer.text(c,a.plotLeft-43,this.plotY+a.plotTop+d/2).attr({zIndex:100,"text-anchor":"middle"}).css({color:"white",fontSize:e}).add(),a.svg_xRect=a.renderer.image(a.resourcePath+"panel_X.png",a.plotLeft+this.plotX-52,a.plotTop+a.plotHeight,102,60).attr({fill:"white",zIndex:99}).add(),a.timeType){case 1:b=Highcharts.dateFormat("%H:%M",this.x);break;case 2:b=Highcharts.dateFormat("%H:%M",this.x);break;case 3:case 4:b=Highcharts.dateFormat("%m.%d",this.x);break;case 5:b=Highcharts.dateFormat("%m",this.x);break;default:b=Highcharts.dateFormat("%H:%M",this.x)}a.svg_xText=a.renderer.text(b,a.plotLeft+this.plotX,a.plotTop+a.plotHeight+45).attr({zIndex:100,"text-anchor":"middle"}).css({color:"white",fontSize:"32px"}).add(),a.hoverPoint=this},J=function(){var a=this.series.chart;a.svg_xText&&(a.svg_xText.destroy(),a.svg_xRect.destroy(),a.svg_yText.destroy(),a.svg_yRect.destroy(),a.svg_xText=null,a.svg_xRect=null,a.svg_yText=null,a.svg_yRect=null),a.hoverPoint=null},K=function(){var a,b=this.chart;switch(b.timeType){case 1:b.recentLength<15&&(a=b.series[0].xData);break;case 3:case 4:b.recentLength<30&&(a=b.series[0].xData);break;default:a=null}return a},L=function(){var a,b=this.chart,c=b.prev||"";switch(b.timeType){case 1:case 2:a=Highcharts.dateFormat("%H:%M",this.value);break;case 3:case 4:a=Highcharts.dateFormat("%m.%d",this.value);break;case 5:a=Highcharts.dateFormat("%m月",this.value);break;default:a=Highcharts.dateFormat("%H:%M",this.value)}return b.prev=a,a===c&&(a=""),a},M={chart:{backgroundColor:"rgba(255,0,0,0)",renderTo:"chart_container"},legend:{enabled:!1},credits:{enabled:!1},plotOptions:{series:{turboThreshold:2e5,stickyTracking:!0,shadow:!1}},title:{text:null},xAxis:{tickLength:0,tickWidth:0,lineWidth:0,title:{text:null}},yAxis:{tickWidth:0,lineWidth:0,title:{text:null}}},N={chartOption:M,renderTo:"",resourcePath:"./images/sagyChart/",autoAxis:!1,autoTooltip:!1,subline:{enabled:!1,lines:[],renderTo:"",deviation:0},convertUnit:{enabled:!0,consistent:!1},ajaxOption:{url:"./chart",transferData:{},index:0,callback:null,pointHandler:null,isJson:!0}};return H.fn=H.prototype={sagyChart:r,constructor:H,init:function(a,b){var d,e,f,h,i=this;a.chartOption||g("chartOption为必选项!"),a.chartOption=j(M,a.chartOption),d=j(N,a),d.autoAxis&&(d.chartOption.xAxis.labels.formatter=L,d.chartOption.xAxis.tickPositioner=K),d.autoTooltip&&(d.chartOption.plotOptions.series.point.events.mouseOver.mouseOut=I,d.chartOption.plotOptions.series.point.events.mouseOut=J),e=F.getElementById(d.renderTo),e||g("页面不存在id为"+d.renderTo+"的元素"),i.subline=h=new q(i,d.subline),i.showLine=p("show",h),i.hideLine=p("hide",h),i.adjustLine=p("adjust",h),f=n(d.chartOption,e),f.resourcePath=d.resourcePath,i.options=d,i.chart=f,i.transferData=d.ajaxOption.transferData,i.version=r,c(b)&&b.call(i)},refresh:function(a,b){var d,e,f,i=this,k=i.options.ajaxOption;a&&(e=a.transferData?a:{transferData:a},d=j(k.transferData,e.transferData),k=j(k,e),k.transferData=d,i.options.ajaxOption=k),f=b?b:k.callback,$.ajax({type:"POST",datatype:"json",data:k.isJson?k.transferData:JSON.stringify(k.transferData),url:k.url,success:function(a){var b;a&&a.yData&&0!==a.yData.length?(i.setData(a,k.index),b=!0):(i.clearData(k.index),h("ajax:"+k.url+" return null"),b=!1),c(f)&&f.call(i,b)},error:function(){g("ajax:"+k.url+" error!")}})},setData:function(c,f){var h,j=this,k=j.subline,l=k.lines,m=j.chart,n=j.options,p=~~f,q=c.xData,r=c.yData,s=!1,t=0;if(b(r)||g("返回json格式有误,yData必须是数组."),b(q)&&d(q[0])?s=!0:b(q)&&a(q[0])&&(s=!1,m.xAxis[0].update({categories:q})),n.autoAxis||n.autoTooltip&&s){for(h=b(r[0])?r[0]:r;t<h.length-1&&null===h[t]||null===h[t+1];)t++;m.timeType=t>=h.length?6:o(q[t+1]-q[t],n.axisRatio),m.recentLength=q.length}if(b(r)&&b(r[0]))for(t=0;t<r.length;t++)j.setValueOnly(q,r[t],t,s,c.unit,c.optional);else j.setValueOnly(q,r,p,s,c.unit,c.optional);n.subline.enabled&&(i(c.lines,function(a,b){l[a].value=b.value}),e(k.showed)||j.adjustLine())},setValueOnly:function(a,b,d,e,f,h){var j,l,n,o,p,q,r=this,s=r.chart,t=r.options,u=t.ajaxOption.pointHandler,v=s.series,w=!0,x=[],A=0,D=function(a,b){return parseInt(a)===A?(o.optional=b,!1):void 0};for(f&&(j=r.convertUnitArr(b,f),r.unit=j.unit,b=j.data),t.ajaxOption.index=d,l=b.filter(function(a){return null!==a}),n=C.apply(y,l),p=B.apply(y,l),A=0;A<b.length;A++)o=new m(e?a[A]:null,b[A]),c(u)&&(o.isMin=o.y===n,o.isMax=o.y===p,h&&i(h,D),u.call(o,r.options.ajaxOption)),o.y=null===o.y?null:z(100*o.y)/100,x.push(o);for(A=x.length-1;A>=0;A--)q=x[A],e&&w&&null!==q.y&&q.x>k(new Date)?(w=!1,q.isLatest=!0):q.isLatest=!1;A=+d+(0>d?v.length:0),v[A]?v[A].setData(x):g("不存在的series,可能因为错误index.")},clearData:function(a,b){var c,d=this.chart.series,e=d.length;a=a>e||-1*e>a?e-1:a,c=+a+(0>a?e:0),b?d[c].destroy():d[c].setData(null)},destroy:function(){var a=this;a.chart.destroy(),a.chart=null,F.getElementById(a.options.renderTo).innerHTML=""},redraw:function(){var a=this;a.chart=new Highcharts.Chart(a.options.chartOption),a.refresh()}},H.fn.init.prototype=H.fn,H.fn.convertUnitArr=function(a,b){var c,d,f=this.options.convertUnit,g=this.subline,h=B.apply(y,a),j=G[b],k=b,l=10>h?-1:0,m=h,n=j,o=[];if(!j)return{data:a,unit:b};if(c=j.ratio,0===l)for(;m>=10*c&&(m/=c,G[n.higherLevel]);)k=n.higherLevel,l++,n=G[n.higherLevel];else k=j.lowerLevel;for(f.consistent&&f.convertedUnit?(k=f.convertedUnit,l=f.convertedLen):(f.convertedUnit=k,f.convertedLen=l),d=0;d<a.length;d++)null===a[d]?o.push(null):o.push(a[d]*D(c,-1*l));return e(g.showed)||i(g.lines,function(a,b){b.convertedValue=b.value*D(c,-1*l)}),{data:o,unit:k}},q.prototype={constructor:q,init:function(a,b){var c=this,d=b.lines;b.renderTo&&(c.node=F.getElementById(b.renderTo)),i(d,function(a,b){b.node=b.renderTo?F.getElementById(b.renderTo):c.node}),c.sagy=a,c.options=b,c.lines=d,c.showed={}},show:function(){var a=arguments,b=this,c=b.lines,e=b.showed;0===a.length?i(c,function(a,b){e["line"+a]=b,b.node&&(b.node.style.display="block")}):d(a[0])?i(a,function(a,b){e["line"+b]=c[b],c[b].node&&(c[b].node.style.display="block")}):i(a[0],function(a,b){e["line"+a]=c[a]=j(c[a],b),c[a].node&&(c[a].node.style.display="block")}),b.adjust()},hide:function(a){var b=this,c=b.sagy.chart.yAxis,d=b.showed;a=~~a,i(d,function(b){c[a].removePlotLine(b),d[b].node&&(d[b].node.style.display="none")}),d={}},adjust:function(){var a,b=this,c=b.showed,d=b.options.deviation,e=b.sagy.chart,f=e.plotTop,g=e.plotSizeY,h=e.yAxis;i(c,function(b,c){a=h[~~c.index],a.removePlotLine(b)}),i(c,function(b,c){var e,i,j,k=c.convertedValue||c.value;a=h[~~c.index],a.addPlotLine({color:c.color,dashStyle:"Solid",width:2,value:k,id:b,zIndex:99}),c.node&&(i=c.node,k>a.max?i.style.top=f-i.scrollHeight/2+d+"px":k<a.min?i.style.top=f+g-i.scrollHeight/2+d+"px":(j=a.plotLinesAndBands[a.plotLinesAndBands.length-1].svgElem,j.shadow(!0),e=j.d,f=e.split(" ",3)[2],i.style.top=f-i.scrollHeight/2+d+"px"))})}},H.numFormat=l,H.version=r,H});